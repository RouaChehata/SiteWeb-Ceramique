<?php
session_start();
require_once '../config.php';

// VÃ©rifier si l'admin est connectÃ©
if (!isset($_SESSION['admin_id'])) {
    header('Location: login.php');
    exit();
}

$message = '';
$error = '';

// Fonction pour gÃ©rer le tÃ©lÃ©chargement d'image
function handleImageUpload($file, $currentImage = '') {
    $targetDir = "../uploads/";
    $allowedTypes = ['jpg', 'jpeg', 'png', 'gif'];
    $maxSize = 2 * 1024 * 1024; // 2MB
    
    // Si pas de nouveau fichier, retourner l'image actuelle
    if (!isset($file['name']) || empty($file['name'])) {
        return $currentImage;
    }
    
    $fileName = basename($file['name']);
    $targetFile = $targetDir . uniqid() . '_' . $fileName;
    $imageFileType = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));
    
    // VÃ©rifier le type de fichier
    if (!in_array($imageFileType, $allowedTypes)) {
        throw new Exception("Seuls les fichiers JPG, JPEG, PNG et GIF sont autorisÃ©s.");
    }
    
    // VÃ©rifier la taille du fichier
    if ($file['size'] > $maxSize) {
        throw new Exception("La taille du fichier ne doit pas dÃ©passer 2MB.");
    }
    
    // TÃ©lÃ©charger le fichier
    if (move_uploaded_file($file['tmp_name'], $targetFile)) {
        // Supprimer l'ancienne image si elle existe
        if (!empty($currentImage) && file_exists('../' . $currentImage)) {
            unlink('../' . $currentImage);
        }
        return str_replace('../', '', $targetFile);
    }
    
    throw new Exception("Une erreur est survenue lors du tÃ©lÃ©chargement du fichier.");
}

// Traitement des actions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['action'])) {
        try {
            // Initialiser les variables
            $name = $description = $price = $category = $stock = $currentImage = $image = '';
            
            // VÃ©rifier les champs obligatoires uniquement pour les actions add et update
            if ($_POST['action'] === 'add' || $_POST['action'] === 'update') {
                if (!isset($_POST['name'], $_POST['description'], $_POST['price'], $_POST['category'], $_POST['stock'])) {
                    throw new Exception("Tous les champs sont obligatoires");
                }
                
                $name = trim($_POST['name']);
                $description = trim($_POST['description']);
                $price = floatval($_POST['price']);
                $category = trim($_POST['category']);
                $stock = intval($_POST['stock']);
                $currentImage = $_POST['currentImage'] ?? '';
                
                // GÃ©rer l'image
                $image = $currentImage;
                if (isset($_FILES['image']) && $_FILES['image']['error'] === UPLOAD_ERR_OK) {
                    $image = handleImageUpload($_FILES['image'], $currentImage);
                }
            }
            
            switch ($_POST['action']) {
                case 'add':
                    if (empty($image)) {
                        throw new Exception("Veuillez sÃ©lectionner une image pour le produit.");
                    }
                    
                    $stmt = $conn->prepare("INSERT INTO products (name, description, price, category, image, stock) VALUES (?, ?, ?, ?, ?, ?)");
                    $stmt->execute([$name, $description, $price, $category, $image, $stock]);
                    $message = "Produit ajoutÃ© avec succÃ¨s";
                    break;
                    
                case 'update':
                    $id = $_POST['id'];
                    $stmt = $conn->prepare("UPDATE products SET name = ?, description = ?, price = ?, category = ?, image = ?, stock = ? WHERE id = ?");
                    $stmt->execute([$name, $description, $price, $category, $image, $stock, $id]);
                    $message = "Produit mis Ã  jour avec succÃ¨s";
                    break;
                
                case 'delete':
                    // VÃ©rifier le jeton CSRF
                    if (!isset($_POST['csrf_token']) || !isset($_SESSION['csrf_token']) || 
                        $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
                        $error = "Jeton de sÃ©curitÃ© invalide. Veuillez rÃ©essayer.";
                        break;
                    }
                    
                    $id = (int)$_POST['id'];
                    if ($id <= 0) {
                        $error = "ID de produit invalide";
                        break;
                    }
                    
                    try {
                        // Commencer une transaction
                        $conn->beginTransaction();
                        
                        // RÃ©cupÃ©rer le chemin de l'image avant de supprimer le produit
                        $stmt = $conn->prepare("SELECT image FROM products WHERE id = ?");
                        $stmt->execute([$id]);
                        $product = $stmt->fetch();
                        
                        if (!$product) {
                            throw new Exception("Produit non trouvÃ©");
                        }
                        
                        // Supprimer le produit
                        $stmt = $conn->prepare("DELETE FROM products WHERE id = ?");
                        $stmt->execute([$id]);
                        
                        // Supprimer l'image associÃ©e si elle existe
                        if (!empty($product['image']) && file_exists('../' . $product['image'])) {
                            unlink('../' . $product['image']);
                        }
                        
                        // Valider la transaction
                        $conn->commit();
                        
                        $message = "Produit supprimÃ© avec succÃ¨s";
                        
                        // Recharger la page pour voir les changements
                        header("Location: products.php?message=" . urlencode($message));
                        exit();
                        
                    } catch (Exception $e) {
                        // Annuler la transaction en cas d'erreur
                        if ($conn->inTransaction()) {
                            $conn->rollBack();
                        }
                        $error = "Erreur lors de la suppression du produit: " . $e->getMessage();
                    }
                    break;
            }
        } catch (Exception $e) {
            $error = $e->getMessage();
        }
    }
}

// GÃ©nÃ©rer un jeton CSRF s'il n'existe pas dÃ©jÃ 
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// RÃ©cupÃ©rer tous les produits
try {
    $stmt = $conn->prepare("SELECT * FROM products ORDER BY created_at DESC");
    $stmt->execute();
    $products = $stmt->fetchAll();
} catch(PDOException $e) {
    $error = "Erreur lors de la rÃ©cupÃ©ration des produits";
}
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Produits - Administration</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../im0.png" alt="Logo" class="admin-logo">
                <h2>Administration</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="index.php" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Tableau de bord</span>
                </a>
                <a href="users.php" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Utilisateurs</span>
                </a>
                <a href="orders.php" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Commandes</span>
                </a>
                <a href="products.php" class="nav-item active">
                    <i class="fas fa-box"></i>
                    <span>Produits</span>
                </a>
                <a href="categories.php" class="nav-item">
                    <i class="fas fa-tags"></i>
                    <span>CatÃ©gories</span>
                </a>
                <a href="settings.php" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>ParamÃ¨tres</span>
                </a>
                <a href="logout.php" class="nav-item logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>DÃ©connexion</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="admin-header">
                <h1>Gestion des Produits</h1>
                    <span>Admin</span>
                    <i class="fas fa-user-circle"></i>
                </div>
            </header>

            <?php if ($message): ?>
                <div class="success-message">
                    <p><?php echo htmlspecialchars($message); ?></p>
                </div>
            <?php endif; ?>

            <?php if ($error): ?>
                <div class="error-message">
                    <p><?php echo htmlspecialchars($error); ?></p>
                </div>
            <?php endif; ?>

            <div class="content-section">
                <div class="section-header">
                    <h2>Liste des Produits</h2>
                    <div class="section-actions">
                        <button class="btn" onclick="openAddModal()">
                            <i class="fas fa-plus"></i>
                            Ajouter un produit
                        </button>
                        <button class="btn" onclick="exportProducts()">
                            <i class="fas fa-download"></i>
                            Exporter
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Image</th>
                                <th>Nom</th>
                                <th>CatÃ©gorie</th>
                                <th>Prix</th>
                                <th>Stock</th>
                                <th>Date d'ajout</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($products as $product): ?>
                            <tr>
                                <td>#<?php echo $product['id']; ?></td>
                                <td>
                                    <?php
                                    $img = isset($product['image']) && !empty($product['image']) ? '../' . htmlspecialchars($product['image']) : '../im0.png';
                                    // VÃ©rifier si le fichier existe cÃ´tÃ© serveur
                                    if (!empty($product['image']) && !file_exists(__DIR__ . '/../' . $product['image'])) {
                                        $img = '../im0.png';
                                    }
                                    ?>
                                    <img src="<?php echo $img; ?>"
                                         alt="<?php echo htmlspecialchars($product['name'] ?? 'Produit'); ?>"
                                         class="product-thumbnail">
                                </td>
                                <td><?php echo htmlspecialchars($product['name'] ?? ''); ?></td>
                                <td><?php echo htmlspecialchars($product['category'] ?? ''); ?></td>
                                <td><?php echo number_format($product['price'] ?? 0, 2); ?> TND</td>
                                <td>
                                    <span class="stock-badge <?php echo (isset($product['stock']) && $product['stock'] > 0) ? 'in-stock' : 'out-of-stock'; ?>">
                                        <?php echo $product['stock'] ?? 0; ?>
                                    </span>
                                </td>
                                <td><?php echo isset($product['created_at']) ? date('d/m/Y', strtotime($product['created_at'])) : ''; ?></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-small" onclick="openEditModal(<?php echo $product['id']; ?>)" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="POST" style="display: inline;" onsubmit="return confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce produit ?')">
                                            <input type="hidden" name="id" value="<?php echo $product['id']; ?>">
                                            <input type="hidden" name="action" value="delete">
                                            <input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">
                                            <button type="submit" class="btn-small btn-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Ajout/Modification Produit -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Ajouter un produit</h2>
            
            <form id="productForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" id="formAction" value="add">
                <input type="hidden" name="id" id="productId">
                
                <div class="form-group">
                    <label for="name">Nom du produit</label>
                    <input type="text" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="4" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Prix (TND)</label>
                        <input type="number" id="price" name="price" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock">Stock</label>
                        <input type="number" id="stock" name="stock" required>
                    </div>
                </div>
                
                <?php
                // RÃ©cupÃ©rer toutes les catÃ©gories depuis la base de donnÃ©es
                $categories = [];
                try {
                    $stmt = $conn->query("SELECT name FROM categories ORDER BY name");
                    $categories = $stmt->fetchAll(PDO::FETCH_COLUMN);
                } catch(PDOException $e) {
                    $error = "Erreur lors de la rÃ©cupÃ©ration des catÃ©gories";
                }
                ?>
                <div class="form-group">
                    <label for="category">CatÃ©gorie</label>
                    <select id="category" name="category" required>
                        <option value="">SÃ©lectionner une catÃ©gorie</option>
                        <?php foreach ($categories as $category): ?>
                            <option value="<?php echo htmlspecialchars($category); ?>"><?php echo htmlspecialchars($category); ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="image">Image du produit</label>
                    <input type="file" id="image" name="image" accept="image/*">
                    <small class="form-text text-muted">Taille maximale : 2MB. Formats acceptÃ©s : JPG, PNG, GIF</small>
                    <div id="imagePreview" style="margin: 15px 0;">
                        <img id="preview" src="#" alt="AperÃ§u de l'image" style="max-width: 100%; max-height: 300px; display: none; border: 1px solid #ddd; border-radius: 4px; padding: 5px; background-color: #f9f9f9;">
                    </div>
                    <input type="hidden" id="currentImage" name="currentImage">
                </div>
                
                <div class="form-actions" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="min-width: 100px;">Annuler</button>
                    <button type="submit" class="btn" style="background-color: #b48a92; min-width: 120px;">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script JavaScript -->
    <script>
        // Fonctions globales
        function openAddModal() {
            console.log('openAddModal called'); // Debug
            const modal = document.getElementById('productModal');
            if (modal) {
                document.getElementById('modalTitle').textContent = 'Ajouter un produit';
                document.getElementById('formAction').value = 'add';
                const form = document.getElementById('productForm');
                if (form) form.reset();
                modal.style.display = 'block';
                
                // RÃ©initialiser l'aperÃ§u de l'image
                const preview = document.getElementById('preview');
                if (preview) {
                    preview.src = '#';
                    preview.style.display = 'none';
                }
                
                // RÃ©initialiser le champ d'image
                const imageInput = document.getElementById('image');
                if (imageInput) imageInput.value = '';
                
                // RÃ©initialiser l'image courante
                const currentImageInput = document.getElementById('currentImage');
                if (currentImageInput) currentImageInput.value = '';
            } else {
                console.error('Modal not found');
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('productModal');
            if (modal) modal.style.display = 'none';
        }
        
        function exportProducts() {
            alert('FonctionnalitÃ© d\'export Ã  implÃ©menter');
        }
        
        function openEditModal(productId) {
            // Charger les donnÃ©es du produit via AJAX
            fetch(`get_product.php?id=${productId}`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('modalTitle').textContent = 'Modifier le produit';
                    document.getElementById('formAction').value = 'update';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('name').value = product.name || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('price').value = product.price || '';
                    document.getElementById('stock').value = product.stock || 0;
                    
                    // Mettre Ã  jour l'aperÃ§u de l'image
                    const preview = document.getElementById('preview');
                    const currentImageInput = document.getElementById('currentImage');
                    
                    if (product.image) {
                        preview.src = '../' + product.image;
                        preview.style.display = 'block';
                        currentImageInput.value = product.image;
                    } else {
                        preview.style.display = 'none';
                        currentImageInput.value = '';
                    }
                    
                    // SÃ©lectionner la catÃ©gorie
                    const categorySelect = document.getElementById('category');
                    for (let i = 0; i < categorySelect.options.length; i++) {
                        if (categorySelect.options[i].value === product.category) {
                            categorySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    document.getElementById('productModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du produit:', error);
                    alert('Erreur lors du chargement des donnÃ©es du produit');
                });
        }
        
        // Initialisation aprÃ¨s chargement du DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded'); // Debug
            
            // Gestion de l'aperÃ§u de l'image
            const imageInput = document.getElementById('image');
            const preview = document.getElementById('preview');
            
            if (imageInput && preview) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // VÃ©rifier le type de fichier
                        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                        if (!validTypes.includes(file.type)) {
                            alert('Veuillez sÃ©lectionner une image valide (JPG, PNG ou GIF)');
                            this.value = '';
                            return;
                        }
                        
                        // VÃ©rifier la taille du fichier (max 2MB)
                        if (file.size > 2 * 1024 * 1024) {
                            alert('La taille de l\'image ne doit pas dÃ©passer 2MB');
                            this.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            preview.src = event.target.result;
                            preview.style.display = 'block';
                            preview.style.maxWidth = '100%';
                            preview.style.height = 'auto';
                            preview.style.marginTop = '10px';
                        }
                        reader.onerror = function() {
                            alert('Une erreur est survenue lors de la lecture du fichier');
                        }
                        reader.readAsDataURL(file);
                    }
                });
                
                // Initialiser l'aperÃ§u si on est en mode Ã©dition
                if (preview.src && preview.src !== '#') {
                    preview.style.display = 'block';
                }
            }
        });
        
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Ajouter un produit';
            document.getElementById('formAction').value = 'add';
        function openEditModal(productId) {
            // Charger les donnÃ©es du produit via AJAX
            fetch(`get_product.php?id=${productId}`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('modalTitle').textContent = 'Modifier le produit';
                    document.getElementById('formAction').value = 'update';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('name').value = product.name || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('price').value = product.price || '';
                    document.getElementById('stock').value = product.stock || 0;
                    
                    // Mettre Ã  jour l'aperÃ§u de l'image
                    const preview = document.getElementById('preview');
                    const currentImageInput = document.getElementById('currentImage');
                    
                    if (product.image) {
                        preview.src = '../' + product.image;
                        preview.style.display = 'block';
                        currentImageInput.value = product.image;
                    } else {
                        preview.style.display = 'none';
                        currentImageInput.value = '';
                    }
                    
                    // SÃ©lectionner la catÃ©gorie
                    const categorySelect = document.getElementById('category');
                    for (let i = 0; i < categorySelect.options.length; i++) {
                        if (categorySelect.options[i].value === product.category) {
                            categorySelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    document.getElementById('productModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du produit:', error);
                    alert('Erreur lors du chargement des donnÃ©es du produit');
                });
                            this.value = '';
                            return;
                        }
                        
                        // VÃ©rifier la taille du fichier (max 2MB)
                        if (file.size > 2 * 1024 * 1024) {
                            alert('La taille de l\'image ne doit pas dÃ©passer 2MB');
                            this.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            preview.src = event.target.result;
                            preview.style.display = 'block';
                        }
                        reader.onerror = function() {
                            alert('Une erreur est survenue lors de la lecture du fichier');
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Fermer la modale avec la croix
            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            // Fermer la modale en cliquant Ã  l'extÃ©rieur
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('productModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html> 
